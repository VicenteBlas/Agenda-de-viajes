{% extends "interfaz_admin.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h2 class="dashboard-title">
    <i class="bi bi-people text-warning"></i>
    <span>Administración de Clientes</span>
  </h2>
  <div>
    <button class="btn btn-outline-primary me-2" id="toggleReunionesBtn">
      <i class="bi bi-calendar-event"></i> Mostrar Reuniones
    </button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClienteModal">
      <i class="bi bi-plus-circle"></i> Nuevo Cliente
    </button>
  </div>
</div>

<!-- Barra de búsqueda mejorada -->
<div class="row mb-4">
  <div class="col-md-8 mx-auto">
    <div class="card shadow-sm">
      <div class="card-body p-3">
        <div class="input-group">
          <span class="input-group-text bg-light border-0">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control border-0 bg-light" 
            id="searchClientesInput" 
            placeholder="Buscar clientes por nombre, apellido o teléfono..."
            aria-label="Buscar clientes"
          >
          <button 
            class="btn btn-outline-secondary" 
            type="button" 
            id="clearSearchBtn"
            style="display: none;"
            title="Limpiar búsqueda"
          >
            <i class="bi bi-x-lg"></i>
          </button>
          <button 
            class="btn btn-primary" 
            type="button" 
            id="searchButton"
            title="Buscar clientes"
          >
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sección de Clientes -->
<div id="clientesSection">
  <div class="row gy-3" id="clientesList">
    <div class="col-12 text-center">
      <div class="spinner-border text-primary"></div>
      <div class="mt-2">Cargando clientes...</div>
    </div>
  </div>
</div>

<!-- Sección de Reuniones Agendadas -->
<div class="mt-5 d-none" id="reunionesSection">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>
      <i class="bi bi-calendar-event text-primary"></i>
      <span>Reuniones Futuras</span>
    </h3>
  </div>
  
  <div class="table-responsive">
    <table class="table table-hover" id="tablaReuniones">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Las reuniones futuras se cargarán dinámicamente -->
      </tbody>
    </table>
  </div>

  <!-- Sección de Reuniones Pasadas -->
  <div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>
        <i class="bi bi-calendar-x text-secondary"></i>
        <span>Reuniones Pasadas</span>
      </h4>
    </div>
    <div class="table-responsive">
      <table class="table table-hover" id="tablaReunionesPasadas">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Las reuniones pasadas se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Agregar Cliente -->
<div class="modal fade" id="addClienteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addClienteForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="nombreInput" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombreInput" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="apellidoPInput" class="form-label">Apellido Paterno</label>
              <input type="text" class="form-control" id="apellidoPInput" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="apellidoMInput" class="form-label">Apellido Materno</label>
              <input type="text" class="form-control" id="apellidoMInput">
            </div>
            <div class="col-md-6 mb-3">
              <label for="telefonoInput" class="form-label">Teléfono</label>
              <input type="text" class="form-control" id="telefonoInput" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="emailInput" class="form-label">Email</label>
            <input type="email" class="form-control" id="emailInput" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="saveClienteBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Cliente -->
<div class="modal fade" id="editClienteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editClienteForm">
          <input type="hidden" id="editClienteId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editNombreInput" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="editNombreInput" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editApellidoPInput" class="form-label">Apellido Paterno</label>
              <input type="text" class="form-control" id="editApellidoPInput" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editApellidoMInput" class="form-label">Apellido Materno</label>
              <input type="text" class="form-control" id="editApellidoMInput">
            </div>
            <div class="col-md-6 mb-3">
              <label for="editTelefonoInput" class="form-label">Teléfono</label>
              <input type="text" class="form-control" id="editTelefonoInput" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="editEmailInput" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmailInput" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="updateClienteBtn">Actualizar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Agendar Reunión Zoom -->
<div class="modal fade" id="zoomInviteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Agendar Reunión en Zoom</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Destinatario:</label>
            <input type="text" class="form-control" id="zoomInviteEmail" readonly>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Enlace de Zoom:</label>
            <input type="text" class="form-control" value="https://us06web.zoom.us/j/81971641072" readonly>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="zoomFecha" class="form-label">Fecha:</label>
            <select class="form-select" id="zoomFecha" required>
              <option value="" selected disabled>Selecciona una fecha</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="zoomHora" class="form-label">Hora:</label>
            <select class="form-select" id="zoomHora" required>
              <option value="" selected disabled>Selecciona una hora</option>
            </select>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="zoomSubject" class="form-label">Asunto:</label>
          <input type="text" class="form-control" id="zoomSubject" value="Invitación a reunión Zoom">
        </div>
        <div class="mb-3">
          <label for="zoomMessage" class="form-label">Mensaje:</label>
          <textarea class="form-control" id="zoomMessage" rows="5">Hola [Nombre],

Te invitamos a una reunión en Zoom con nuestro equipo.

Fecha: [Fecha]
Hora: [Hora]

Enlace: https://us06web.zoom.us/j/81971641072

Saludos cordiales,
Equipo Corporativo Vicente Blas SAS DE CV</textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="sendZoomInviteBtn">
          <i class="bi bi-send"></i> Agendar y Enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Contenedor para toasts -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>
{% endblock %}

{% block scripts %}
<style>
  .cliente-card {
    position: relative;
    border: 1px solid #e1e1e1;
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: box-shadow 0.2s;
  }
  .cliente-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .cliente-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .cliente-card:hover .cliente-actions {
    visibility: visible;
    opacity: 1;
  }
  .cliente-extra-actions {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px dashed #eee;
    display: flex;
    gap: 0.5rem;
  }
  .btn-zoom {
    background-color: #2D8CFF;
    color: white;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
  }
  .btn-zoom:hover {
    background-color: #1a73e8;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .btn-whatsapp {
    background-color: #25D366;
    color: white;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
  }
  .btn-whatsapp:hover {
    background-color: #128C7E;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .btn-icon {
    font-size: 1rem;
  }
  #zoomMessage {
    font-family: inherit;
    white-space: pre-wrap;
  }
  #zoomFecha, #zoomHora {
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #ced4da;
  }
  #zoomFecha option, #zoomHora option {
    padding: 0.5rem;
  }
  #zoomFecha option:checked, #zoomHora option:checked {
    background-color: #0d6efd;
    color: white;
  }
  #tablaReuniones th,
  #tablaReunionesPasadas th {
    white-space: nowrap;
  }
  #tablaReuniones td,
  #tablaReunionesPasadas td {
    vertical-align: middle;
  }
  #tablaReunionesPasadas {
    opacity: 0.8;
  }
  #tablaReunionesPasadas th {
    background-color: #f8f9fa;
  }
  #tablaReunionesPasadas tr.table-secondary td {
    color: #6c757d;
  }
  /* Estilos para la barra de búsqueda */
  #searchClientesInput:focus {
    box-shadow: none;
    background-color: #fff;
    border: 1px solid #dee2e6 !important;
  }
  #searchClientesInput {
    transition: all 0.3s ease;
  }
  #clearSearchBtn, #searchButton {
    transition: all 0.2s;
  }
  #clearSearchBtn:hover {
    background-color: #f8f9fa;
  }
  .search-highlight {
    background-color: #fff3cd;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 3px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Variables globales
  let todosClientes = [];
  let currentSearchTerm = '';

  // Función para mostrar notificaciones
  function showToast(title, message, isError = false, duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <strong>${title}</strong><br>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {delay: duration});
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }

  // Cargar clientes al iniciar
  cargarClientes();

  // Función para cargar clientes
  async function cargarClientes() {
    try {
      showLoading(true);
      const res = await fetch('/api/clientes');
      if (!res.ok) throw new Error('Error al cargar clientes');
      
      todosClientes = await res.json();
      renderClientes(todosClientes);
    } catch (err) {
      console.error('Error al cargar clientes:', err);
      showToast('Error', 'No se pudieron cargar los clientes', true);
    } finally {
      showLoading(false);
    }
  }

  // Mostrar/ocultar spinner de carga
  function showLoading(show) {
    const spinner = document.querySelector('#clientesList .spinner-border');
    const loadingText = document.querySelector('#clientesList .mt-2');
    if (spinner && loadingText) {
      spinner.style.display = show ? 'block' : 'none';
      loadingText.style.display = show ? 'block' : 'none';
    }
  }

  // Función para renderizar clientes
  function renderClientes(clientes) {
    const list = document.getElementById('clientesList');
    
    // Si está vacío, mostrar mensaje apropiado
    if (clientes.length === 0) {
      list.innerHTML = `
        <div class="col-12 text-center text-muted py-4">
          <i class="bi bi-${currentSearchTerm ? 'search' : 'person-x'}" style="font-size:2rem;"></i>
          <div>${currentSearchTerm ? 'No se encontraron clientes' : 'No hay clientes registrados'}</div>
          ${currentSearchTerm ? 
            `<button class="btn btn-sm btn-link mt-2" onclick="window.cargarClientes()">
              Mostrar todos los clientes
            </button>` : ''
          }
        </div>`;
      return;
    }
    
    // Limpiar lista
    list.innerHTML = '';
    
    // Crear tarjetas para cada cliente
    clientes.forEach(cliente => {
      const div = document.createElement('div');
      div.className = 'col-12';
      div.id = `card-cliente-${cliente.idCliente}`;
      
      // Resaltar coincidencias de búsqueda
      const nombre = highlightMatches(cliente.Nombre, currentSearchTerm);
      const apellidoP = highlightMatches(cliente.Apellido_P, currentSearchTerm);
      const apellidoM = cliente.Apellido_M ? highlightMatches(cliente.Apellido_M, currentSearchTerm) : '';
      const telefono = highlightMatches(cliente.Telefono, currentSearchTerm);
      
      div.innerHTML = `
        <div class="cliente-card">
          <div class="cliente-actions">
            <button class="btn btn-sm btn-link text-primary" onclick="window.editarCliente(${cliente.idCliente},'${escapeHtml(cliente.Nombre)}','${escapeHtml(cliente.Apellido_P)}','${escapeHtml(cliente.Apellido_M||'')}','${escapeHtml(cliente.Telefono)}','${escapeHtml(cliente.Email)}')" title="Editar">
              <i class="bi bi-pencil-fill"></i>
            </button>
            <button class="btn btn-sm btn-link text-danger" onclick="window.eliminarCliente(${cliente.idCliente})" title="Eliminar">
              <i class="bi bi-trash-fill"></i>
            </button>
          </div>
          <div><i class="bi bi-person-circle me-2 text-warning"></i> <strong>${nombre} ${apellidoP} ${apellidoM}</strong></div>
          <div class="text-muted small mt-1">
            <div><i class="bi bi-telephone"></i> ${telefono}</div>
            <div><i class="bi bi-envelope"></i> ${escapeHtml(cliente.Email)}</div>
          </div>
          <div class="cliente-extra-actions">
            <button class="btn btn-zoom" onclick="window.prepararInvitacionZoom('${escapeHtml(cliente.Nombre)}', '${escapeHtml(cliente.Email)}')">
              <i class="bi bi-camera-video-fill btn-icon"></i> Agendar Zoom
            </button>
            <button class="btn btn-whatsapp" onclick="window.enviarWhatsApp('${escapeHtml(cliente.Telefono)}')">
              <i class="bi bi-whatsapp btn-icon"></i> WhatsApp
            </button>
          </div>
        </div>`;
      list.appendChild(div);
    });
  }

  // Escapar HTML para prevenir XSS
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Función para resaltar coincidencias
  function highlightMatches(text, term) {
    if (!term || !text) return escapeHtml(text);
    
    const escapedText = escapeHtml(text.toString());
    const escapedTerm = escapeHtml(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    
    try {
      const regex = new RegExp(escapedTerm, 'gi');
      return escapedText.replace(regex, match => 
        `<span class="search-highlight">${match}</span>`
      );
    } catch (e) {
      return escapedText;
    }
  }

  // Función para buscar clientes
  function buscarClientes(termino) {
    currentSearchTerm = termino.toLowerCase().trim();
    
    if (!currentSearchTerm) {
      renderClientes(todosClientes);
      return;
    }
    
    const clientesFiltrados = todosClientes.filter(cliente => {
      return (
        cliente.Nombre.toLowerCase().includes(currentSearchTerm) ||
        cliente.Apellido_P.toLowerCase().includes(currentSearchTerm) ||
        (cliente.Apellido_M && cliente.Apellido_M.toLowerCase().includes(currentSearchTerm)) ||
        cliente.Telefono.includes(currentSearchTerm)
      );
    });
    
    renderClientes(clientesFiltrados);
  }

  // Event listeners para búsqueda
  document.getElementById('searchClientesInput').addEventListener('input', function(e) {
    const termino = e.target.value.trim();
    const clearBtn = document.getElementById('clearSearchBtn');
    
    if (termino.length > 0) {
      clearBtn.style.display = 'block';
      if (termino.length >= 2) {
        buscarClientes(termino);
      } else if (termino.length === 0) {
        renderClientes(todosClientes);
      }
    } else {
      clearBtn.style.display = 'none';
      currentSearchTerm = '';
      renderClientes(todosClientes);
    }
  });

  document.getElementById('searchButton').addEventListener('click', function() {
    const termino = document.getElementById('searchClientesInput').value.trim();
    buscarClientes(termino);
  });

  document.getElementById('clearSearchBtn').addEventListener('click', function() {
    document.getElementById('searchClientesInput').value = '';
    this.style.display = 'none';
    currentSearchTerm = '';
    renderClientes(todosClientes);
  });

  // Toggle para mostrar/ocultar reuniones
  document.getElementById('toggleReunionesBtn').addEventListener('click', function() {
    const reunionesSection = document.getElementById('reunionesSection');
    const clientesSection = document.getElementById('clientesSection');
    const btn = this;
    
    reunionesSection.classList.toggle('d-none');
    clientesSection.classList.toggle('d-none');
    
    if (reunionesSection.classList.contains('d-none')) {
      btn.innerHTML = '<i class="bi bi-calendar-event"></i> Mostrar Reuniones';
    } else {
      btn.innerHTML = '<i class="bi bi-people"></i> Mostrar Clientes';
      cargarReunionesAgendadas();
    }
  });

  // Función para cargar reuniones agendadas
  async function cargarReunionesAgendadas() {
    try {
      const response = await fetch('/api/reuniones');
      if (!response.ok) throw new Error('Error al cargar reuniones');
      
      const reuniones = await response.json();
      const tbody = document.querySelector('#tablaReuniones tbody');
      const tbodyPasadas = document.querySelector('#tablaReunionesPasadas tbody');
      
      tbody.innerHTML = '';
      tbodyPasadas.innerHTML = '';

      if (reuniones.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              No hay reuniones agendadas
            </td>
          </tr>`;
        tbodyPasadas.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              No hay reuniones pasadas
            </td>
          </tr>`;
        return;
      }

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      let hayFuturas = false;
      let hayPasadas = false;

      reuniones.forEach(reunion => {
        const tr = document.createElement('tr');
        const fechaReunion = new Date(reunion.fecha);
        const esPasada = fechaReunion < hoy;

        tr.innerHTML = `
          <td>${reunion.id_r}</td>
          <td>${escapeHtml(reunion.cliente)}</td>
          <td>${escapeHtml(reunion.fecha_formateada || 'No especificada')}</td>
          <td>${escapeHtml(reunion.hora_formateada || 'No especificada')}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="window.eliminarReunion(${reunion.id_r})">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>`;

        if (esPasada) {
          tr.classList.add('table-secondary');
          tbodyPasadas.appendChild(tr);
          hayPasadas = true;
        } else {
          tbody.appendChild(tr);
          hayFuturas = true;
        }
      });

      if (!hayFuturas) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              No hay reuniones futuras agendadas
            </td>
          </tr>`;
      }

      if (!hayPasadas) {
        tbodyPasadas.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              No hay reuniones pasadas
            </td>
          </tr>`;
      }

    } catch (error) {
      console.error('Error al cargar reuniones:', error);
      showToast('Error', 'No se pudieron cargar las reuniones agendadas', true);
    }
  }

  // Función para cargar fechas disponibles
  async function cargarFechasDisponibles() {
    try {
      const response = await fetch('/api/fechas');
      if (!response.ok) throw new Error('Error al cargar fechas');
      
      const fechas = await response.json();
      const selectFecha = document.getElementById('zoomFecha');
      
      selectFecha.innerHTML = '<option value="" selected disabled>Selecciona una fecha</option>';
      
      fechas.forEach(fecha => {
        const option = document.createElement('option');
        option.value = fecha.Fecha;
        option.textContent = new Date(fecha.Fecha).toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        selectFecha.appendChild(option);
      });
    } catch (error) {
      console.error('Error al cargar fechas:', error);
      showToast('Error', 'No se pudieron cargar las fechas disponibles', true);
    }
  }

  // Función para cargar horas disponibles
  async function cargarHorasDisponibles() {
    try {
      const response = await fetch('/api/horas');
      if (!response.ok) throw new Error('Error al cargar horas');
      
      const horas = await response.json();
      const selectHora = document.getElementById('zoomHora');
      
      selectHora.innerHTML = '<option value="" selected disabled>Selecciona una hora</option>';
      
      horas.forEach(hora => {
        const option = document.createElement('option');
        option.value = hora.Hora;
        option.textContent = hora.Hora;
        selectHora.appendChild(option);
      });
    } catch (error) {
      console.error('Error al cargar horas:', error);
      showToast('Error', 'No se pudieron cargar las horas disponibles', true);
    }
  }

  // Función para preparar la invitación Zoom
  window.prepararInvitacionZoom = function(nombre, email) {
    if (!email || !email.includes('@')) {
      showToast('Error', 'El correo electrónico no es válido', true);
      return;
    }

    cargarFechasDisponibles();
    cargarHorasDisponibles();

    document.getElementById('zoomInviteEmail').value = `${escapeHtml(nombre)} <${escapeHtml(email)}>`;
    
    const messageTextarea = document.getElementById('zoomMessage');
    messageTextarea.value = `Hola ${escapeHtml(nombre)},

Te invitamos a una reunión en Zoom con nuestro equipo.

Fecha: [Fecha]
Hora: [Hora]

Enlace: https://us06web.zoom.us/j/81971641072

Saludos cordiales,
Equipo Corporativo Vicente Blas SAS DE CV`;
    
    const zoomModal = new bootstrap.Modal(document.getElementById('zoomInviteModal'));
    zoomModal.show();
  };
  
  // Función para enviar invitación Zoom
  document.getElementById('sendZoomInviteBtn').addEventListener('click', async function() {
    const emailMatch = document.getElementById('zoomInviteEmail').value.match(/<(.+)>/);
    if (!emailMatch) {
      showToast('Error', 'El correo electrónico no es válido', true);
      return;
    }
    
    const email = emailMatch[1];
    const nombre = document.getElementById('zoomInviteEmail').value.split(' <')[0];
    const subject = document.getElementById('zoomSubject').value;
    let message = document.getElementById('zoomMessage').value;
    const fechaSeleccionada = document.getElementById('zoomFecha').value;
    const horaSeleccionada = document.getElementById('zoomHora').value;
    
    if (!subject || !message || !fechaSeleccionada || !horaSeleccionada) {
      showToast('Error', 'Completa todos los campos obligatorios', true);
      return;
    }
    
    const fechaFormateada = new Date(fechaSeleccionada).toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    message = message
      .replace('[Nombre]', nombre)
      .replace('[Fecha]', fechaFormateada)
      .replace('[Hora]', horaSeleccionada);
    
    showToast('Info', 'Enviando invitación...', false, 2000);
    
    try {
      const response = await fetch('/api/enviar-invitacion-zoom', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email: email,
          nombre: nombre,
          subject: subject,
          message: message,
          fecha: fechaSeleccionada,
          hora: horaSeleccionada
        })
      });
      
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Éxito', 'Reunión agendada e invitación enviada correctamente');
        bootstrap.Modal.getInstance(document.getElementById('zoomInviteModal')).hide();
        cargarReunionesAgendadas();
      } else {
        throw new Error(data.message || 'Error al enviar');
      }
    } catch (error) {
      console.error('Error al enviar:', error);
      showToast('Error', 'No se pudo agendar la reunión', true);
    }
  });

  // Función para eliminar una reunión
  window.eliminarReunion = async function(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar esta reunión?')) {
      return;
    }

    try {
      const response = await fetch(`/api/reuniones/${id}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      
      const data = await response.json();

      if (data.success) {
        showToast('Éxito', 'Reunión eliminada correctamente');
        cargarReunionesAgendadas();
      } else {
        throw new Error(data.message || 'Error al eliminar');
      }
    } catch (error) {
      console.error('Error al eliminar reunión:', error);
      showToast('Error', 'No se pudo eliminar la reunión', true);
    }
  };

  // Función para enviar WhatsApp
  window.enviarWhatsApp = function(telefono) {
    const numeroLimpio = telefono.replace(/\D/g, '');
    if (!numeroLimpio) {
      showToast('Error', 'Número de teléfono no válido', true);
      return;
    }
    
    const mensaje = 'Hola, ¿cómo estás? Me gustaría ponerme en contacto contigo.';
    const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
    
    window.open(urlWhatsApp, '_blank');
  };

  // Funciones CRUD para clientes
  window.agregarCliente = async function() {
    const cliente = {
      Nombre: document.getElementById('nombreInput').value.trim(),
      Apellido_P: document.getElementById('apellidoPInput').value.trim(),
      Apellido_M: document.getElementById('apellidoMInput').value.trim(),
      Telefono: document.getElementById('telefonoInput').value.trim(),
      Email: document.getElementById('emailInput').value.trim(),
      Prospecto_idProspecto: 1,
      Pais_idPais: 1
    };
    
    if (!cliente.Nombre || !cliente.Apellido_P || !cliente.Telefono || !cliente.Email) {
      return showToast('Error', 'Completa todos los campos obligatorios', true);
    }
    
    try {
      const res = await fetch('/api/clientes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(cliente)
      });
      
      if (!res.ok) throw new Error('Error en la respuesta del servidor');
      
      const data = await res.json();
      
      if (data.success && data.nuevoCliente) {
        todosClientes.push(data.nuevoCliente);
        renderClientes(todosClientes);
        bootstrap.Modal.getInstance(document.getElementById('addClienteModal')).hide(); 
        document.getElementById('addClienteForm').reset();
        showToast('Éxito', 'Cliente agregado correctamente');
      } else {
        throw new Error(data.message || 'No se pudo agregar el cliente');
      }
    } catch (e) { 
      console.error('Error al agregar:', e); 
      showToast('Error', 'Error al agregar cliente: ' + (e.message || ''), true);
    }
  };

  window.editarCliente = function(id, n, aP, aM, tel, mail) {
    document.getElementById('editClienteId').value = id; 
    document.getElementById('editNombreInput').value = n; 
    document.getElementById('editApellidoPInput').value = aP;
    document.getElementById('editApellidoMInput').value = aM; 
    document.getElementById('editTelefonoInput').value = tel; 
    document.getElementById('editEmailInput').value = mail;
    new bootstrap.Modal(document.getElementById('editClienteModal')).show();
  };

  window.actualizarCliente = async function() {
    const id = document.getElementById('editClienteId').value;
    const cliente = {
      Nombre: document.getElementById('editNombreInput').value.trim(),
      Apellido_P: document.getElementById('editApellidoPInput').value.trim(),
      Apellido_M: document.getElementById('editApellidoMInput').value.trim(),
      Telefono: document.getElementById('editTelefonoInput').value.trim(),
      Email: document.getElementById('editEmailInput').value.trim(),
      Prospecto_idProspecto: 1,
      Pais_idPais: 1
    };
    
    if (!cliente.Nombre || !cliente.Apellido_P || !cliente.Telefono || !cliente.Email) {
      return showToast('Error', 'Completa todos los campos obligatorios', true);
    }
    
    try {
      const res = await fetch(`/api/clientes/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(cliente)
      });
      
      if (!res.ok) throw new Error('Error en la respuesta del servidor');
      
      const data = await res.json();
      
      if (data.success) {
        // Actualizar el cliente en el array
        const index = todosClientes.findIndex(c => c.idCliente == id);
        if (index !== -1) {
          todosClientes[index] = {...todosClientes[index], ...cliente};
        }
        
        renderClientes(currentSearchTerm ? 
          todosClientes.filter(c => 
            c.Nombre.toLowerCase().includes(currentSearchTerm) ||
            c.Apellido_P.toLowerCase().includes(currentSearchTerm) ||
            (c.Apellido_M && c.Apellido_M.toLowerCase().includes(currentSearchTerm)) ||
            c.Telefono.includes(currentSearchTerm)
          ) : todosClientes
        );
        
        bootstrap.Modal.getInstance(document.getElementById('editClienteModal')).hide();
        showToast('Éxito', 'Cliente actualizado correctamente');
      } else {
        throw new Error(data.message || 'No se pudo actualizar el cliente');
      }
    } catch (e) {
      console.error('Error al actualizar:', e);
      showToast('Error', 'Error al actualizar cliente: ' + (e.message || ''), true);
    }
  };

  window.eliminarCliente = async function(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar este cliente?')) return;
    
    try {
      const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
      
      if (!res.ok) throw new Error('Error en la respuesta del servidor');
      
      const data = await res.json();
      
      if (data.success) {
        todosClientes = todosClientes.filter(c => c.idCliente != id);
        renderClientes(currentSearchTerm ? 
          todosClientes.filter(c => 
            c.Nombre.toLowerCase().includes(currentSearchTerm) ||
            c.Apellido_P.toLowerCase().includes(currentSearchTerm) ||
            (c.Apellido_M && c.Apellido_M.toLowerCase().includes(currentSearchTerm)) ||
            c.Telefono.includes(currentSearchTerm)
          ) : todosClientes
        );
        showToast('Éxito', 'Cliente eliminado correctamente');
      } else {
        throw new Error(data.message || 'Error al eliminar');
      }
    } catch (e) {
      console.error('Error al eliminar:', e);
      showToast('Error', 'No se pudo eliminar el cliente: ' + (e.message || ''), true);
    }
  };

  // Event listeners para los botones de guardar/actualizar
  document.getElementById('saveClienteBtn').addEventListener('click', window.agregarCliente);
  document.getElementById('updateClienteBtn').addEventListener('click', window.actualizarCliente);

  // Inicialización de tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}